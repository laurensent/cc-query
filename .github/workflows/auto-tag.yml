name: Auto Tag

on:
  push:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      skip: ${{ steps.version.outputs.skip }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Determine next version
        id: version
        run: |
          # Get latest tag
          LATEST=$(git tag --list 'v*' --sort=-v:refname | head -1)
          if [ -z "$LATEST" ]; then
            echo "tag=v0.1.0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Parse current version
          VERSION=${LATEST#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Analyze commits since last tag
          COMMITS=$(git log "$LATEST"..HEAD --pretty=format:"%s")
          if [ -z "$COMMITS" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          BUMP=""
          while IFS= read -r msg; do
            if echo "$msg" | grep -qE '!:|BREAKING CHANGE'; then
              BUMP="minor"
              break
            elif echo "$msg" | grep -qE '^(chore|docs)(\(.*\))?:'; then
              continue
            elif echo "$msg" | grep -qE '^[a-z]+(\(.*\))?!?:'; then
              [ "$BUMP" != "minor" ] && BUMP="patch"
            fi
          done <<< "$COMMITS"

          if [ -z "$BUMP" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          case $BUMP in
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          echo "tag=v${MAJOR}.${MINOR}.${PATCH}" >> "$GITHUB_OUTPUT"

      - name: Push tag
        if: steps.version.outputs.skip != 'true'
        run: |
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

  release:
    needs: tag
    if: needs.tag.outputs.skip != 'true'
    uses: ./.github/workflows/release.yml
    with:
      tag: ${{ needs.tag.outputs.tag }}
    secrets: inherit
